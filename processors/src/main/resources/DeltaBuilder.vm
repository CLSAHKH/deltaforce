#set ($class_name = "${model.deltaBuilderClassName}")
package ${model.packageName};

import org.namstorm.deltaforce.core.*;
import javax.annotation.Generated;

/**
* Builder for $class_name
*
* @use  ${model.className} $class_name.[from(${model.className} start)]
*               .[set]XXX(value) - for normal values
*           or  .[set|clear]XXX(key, value) - for maps
*           or  .[add|remove]XXX(value) - for sets
*           or  .[setXXXAt(index, value)|removeXXXAt(index)|remove(value)]
*          .[build()|apply()]
*/
@Generated(value="$generatorClassName", date="${date}")
public class $class_name extends AbstractDeltaBuilder<${model.className}> {

    public $class_name($model.className from) {super(from);}
    public $class_name() {super(new ${model.className}());}

    public static ${model.className} create${model.className}() { return new ${model.className}(); }

    @Override public ${model.className} create() { return create${model.className}(); }

    @Override public $class_name from($model.className from) { super.from(from); return this; }
    @Override public $class_name op(Delta.OP op) { super.op(op); return this; }


#foreach($field in $fields)

    // AccessorType : ${field.accessorType}
    #if( ${field.accessorType} == "field" )
        #set ($alias = "${field.alias}")
    /**
    * Sets the value on the underlying and records a delta (if values are different)
    *
    * @return the property descriptor
    */
    public $class_name set$alias(final $field.type newValue) {
        // first check if we already have a delta of this field
        ${field.boxedType} curValue;

        if(deltaMap().containsKey("${field.name}")) {
            curValue = ($field.boxedType) deltaMap().get("${field.name}").getOldValue();
        }else {
        #if( ${field.primitive} )
            curValue = ${field.boxedType}.valueOf( _from().get$alias() );
        #else
            curValue = _from().get$alias();
        #end
        }

        Delta.OP op = compare(curValue, newValue);

        if(op != Delta.OP.NOOP) addDelta(new Delta(op, "${field.name}", curValue, newValue));

        return this;
    }
    #elseif( ${field.accessorType}=="map" )
        #set ($alias = "${field.alias}")

    public $class_name set$alias(final ${field.key.type} key, final ${field.value.type} value) {

        ${field.value.boxedType} curValue =
        #if( ${field.primitive} ) ${field.boxedType}.valueOf( _from().get$alias(key) );
        #else _from().get$alias(key); #end

        Delta.OP op = compare(curValue, value);

        if(op!=Delta.OP.NOOP) addMapDelta("${field.name}", #if( ${field.accessible} ) _from().${field.name} #else null #end, new Delta(op, key, curValue, value));

        return this;
    }
    #elseif (${field.accessorType}=="collection")

    public $class_name add${field.alias}(final ${field.value.type} value) { addToCollection( "${field.name}", #if( ${field.accessible} ) _from().${field.name} #else _from().get${util.StringUtils.capitalizeFirstLetter($field.name)}() #end, value ); return this; }
    public $class_name remove${field.alias}(final ${field.value.type} value) { removeFromCollection( "${field.name}", #if( ${field.accessible} ) _from().${field.name} #else _from().get${util.StringUtils.capitalizeFirstLetter($field.name)}() #end, value); return this; }

    #elseif (${field.accessorType}=="buildable")

    /** deletes the object (ie marks the delta to delete it) */
    public $class_name delete${field.alias}() { edit${field.alias}(null); return this; }
    public ${field.builderFullClassName} edit${field.alias}() { return edit${field.alias}( ${field.builderFullClassName}.create${field.className}() ); }

    /** edits the value using a builder */
    protected ${field.builderFullClassName} edit${field.alias}(${field.type} newValue) {
        // let's see if we have the delta setup already
        BuildableDelta<${field.type}> bd = ((BuildableDelta<${field.type}>) delta("${field.name}"));

        // if not, set this up
        if(bd == null) {
            bd = createBuildableDelta("${field.name}", #if( ${field.accessible} ) _from().${field.name} #else _from().get${field.alias}() #end, newValue, new ${field.builderFullClassName}() );
            addDelta(bd);
        }

        return (${field.builderFullClassName}) bd.getBuilder();
    }
    #end

#end

    public ${model.className} apply() {
        return applyTo(_from());
    }


    /**
    * apply deltas
    * @Override
    * @param to ${model.className} to apply deltas to
    * @return ${model.className} to object with deltas applies
    */
    public ${model.className} applyTo(${model.className} to) {

        #foreach($field in $fields)
            #set ($alias = "${field.alias}")

            if(deltaMap().containsKey("${field.name}")){
            #if( ${field.accessorType} == "field" )
                to.#if( ${field.accessible} )${field.name} = ((Delta<${field.boxedType}>) deltaMap().get("${field.name}")).getNewValue(); #else set$alias( ((Delta<${field.boxedType}>) deltaMap().get("${field.name}")).getNewValue() );#end
            #elseif (${field.accessorType} == "map")
                #if( ${field.accessible} )
                delta("${field.name}").applyTo(to.${field.name});
                #else
                for(${field.key.boxedType} key: map ) {
                    to.set$alias(key, map.get(key));
                }
                #end
            #elseif (${field.accessorType}=="collection")
                #if( ${field.accessible} )
                to.${field.name} = (${field.type}) delta("${field.name}").applyTo(to.${field.name});
                #else
                to.set${util.StringUtils.capitalizeFirstLetter($field.name)}( (${field.type}) delta("${field.name}").applyTo(to.get${util.StringUtils.capitalizeFirstLetter($field.name)}()) );
                #end
            #elseif (${field.accessorType}=="buildable")
                #if( ${field.accessible} )
                to.${field.name} = (${field.type}) delta("${field.name}").applyTo(to.${field.name});
                #else
                to.set${util.StringUtils.capitalizeFirstLetter($field.name)}( (${field.type}) delta("${field.name}").applyTo(to.get${util.StringUtils.capitalizeFirstLetter($field.name)}()) );
                #end
            #end
            }
        #end

        return to;

    }

}
